# Firebase Studio

This is a NextJS starter in Firebase Studio.

To get started, take a look at src/app/page.tsx.

## Supabase Schema

To use this application with Supabase, you need to create the following tables and policies in your Supabase project. You can run this SQL code in the Supabase SQL Editor.

```sql
-- 1. Enable RLS on all tables in your project settings.
-- 2. After creating the tables, set up a trigger to sync new users to the profiles table.
--    Go to Database > Triggers and create a new trigger on the `auth.users` table for the `INSERT` event.
--    The function to run should be:
--    `public.handle_new_user()`
--    And the function definition is:
/*
create function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.profiles (id, email)
  values (new.id, new.email);
  return new;
end;
$$;
*/


-- Profiles table to store public user data
CREATE TABLE public.profiles (
  id uuid NOT NULL REFERENCES auth.users ON DELETE CASCADE,
  updated_at timestamp with time zone,
  name text,
  email text,
  role text,
  status text,
  avatar text,
  fallback text,
  PRIMARY KEY (id)
);
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
-- Policies for profiles:
CREATE POLICY "Public profiles are viewable by authenticated users." ON public.profiles FOR SELECT TO authenticated USING (true);
CREATE POLICY "Users can update own profile." ON public.profiles FOR UPDATE USING (auth.uid() = id) WITH CHECK (auth.uid() = id);
CREATE POLICY "Admins can update any profile." ON public.profiles FOR UPDATE TO authenticated USING ((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador');
CREATE POLICY "Admins can delete profiles." ON public.profiles FOR DELETE TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador') AND (auth.uid() <> id));

-- Products table
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text NOT NULL,
  category text NOT NULL,
  sizes jsonb,
  price numeric,
  "isAvailable" boolean NOT NULL DEFAULT true,
  description text,
  PRIMARY KEY (id)
);
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Products are viewable by authenticated users." ON public.products FOR SELECT TO authenticated USING (true);
CREATE POLICY "Admins can manage products." ON public.products FOR ALL TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador')) WITH CHECK (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador'));

-- Customers table
CREATE TABLE public.customers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  name text NOT NULL,
  phone text NOT NULL,
  address text,
  "locationLink" text,
  "lastOrderDate" date NOT NULL,
  "totalSpent" numeric NOT NULL,
  "orderCount" integer NOT NULL,
  PRIMARY KEY (id)
);
ALTER TABLE public.customers ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Customers are viewable by authenticated users." ON public.customers FOR SELECT TO authenticated USING (true);
CREATE POLICY "Admins can manage customers." ON public.customers FOR ALL TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador')) WITH CHECK (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador'));


-- Orders table
CREATE TABLE public.orders (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  "customerName" text NOT NULL,
  "customerPhone" text,
  items jsonb NOT NULL,
  total numeric NOT NULL,
  status text NOT NULL,
  timestamp text NOT NULL,
  "orderType" text NOT NULL,
  address text,
  "locationLink" text,
  notes text
);
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Orders are viewable by authenticated users." ON public.orders FOR SELECT TO authenticated USING (true);
CREATE POLICY "Authenticated users can create orders." ON public.orders FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Users can update orders." ON public.orders FOR UPDATE TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) IN ('Administrador', 'FuncionÃ¡rio')));
CREATE POLICY "Admins can delete orders." ON public.orders FOR DELETE TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador'));


-- Notifications table
CREATE TABLE public.notifications (
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    title text NOT NULL,
    description text NOT NULL,
    "isRead" boolean NOT NULL DEFAULT false,
    "targetRoles" jsonb NOT NULL,
    link text,
    PRIMARY KEY (id)
);
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view their own notifications." ON public.notifications FOR SELECT TO authenticated USING ("targetRoles" @> to_jsonb((SELECT role FROM public.profiles WHERE id = auth.uid())::text));
CREATE POLICY "Authenticated users can create notifications." ON public.notifications FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Users can update notifications to mark as read." ON public.notifications FOR UPDATE TO authenticated USING ("targetRoles" @> to_jsonb((SELECT role FROM public.profiles WHERE id = auth.uid())::text));

-- Settings table (singleton, only one row)
CREATE TABLE public.settings (
  id int8 PRIMARY KEY,
  "basePrices" jsonb,
  "sizeAvailability" jsonb
);
ALTER TABLE public.settings ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Settings are viewable by authenticated users" ON public.settings FOR SELECT TO authenticated USING (true);
CREATE POLICY "Admins can update settings" ON public.settings FOR UPDATE TO authenticated USING (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador')) WITH CHECK (((SELECT role FROM public.profiles WHERE id = auth.uid()) = 'Administrador'));

-- Insert the single row of settings
INSERT INTO public.settings (id, "basePrices", "sizeAvailability")
VALUES (
  1,
  '{"GG": 65, "medio": 45, "grande": 55, "pequeno": 35}',
  '{"GG": true, "medio": true, "grande": true, "pequeno": true}'
);
```
